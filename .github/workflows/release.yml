name: üöÄ Release
run-name: üöÄ Release from ${{ github.ref_name }}

on:
  workflow_dispatch:

jobs:
  release:
    if: startsWith(github.ref_name, 'release/')
    runs-on: ubuntu-latest
    permissions:
      contents: write
    environment:
      name: maven-central
      url: ${{ steps.gh-release.outputs.url }}

    steps:
    - name: üì• Checkout
      uses: actions/checkout@v6
      with:
        fetch-depth: 0

    - name: ‚òï Set up JDK
      uses: actions/setup-java@v5
      with:
        distribution: temurin
        java-version: 25
        cache: maven
        server-id: central
        server-username: CENTRAL_USERNAME
        server-password: CENTRAL_PASSWORD
        gpg-private-key: ${{ secrets.GPG_PRIVATE_KEY }}
        gpg-passphrase: MAVEN_GPG_PASSPHRASE

    - name: üè∑Ô∏è Extract Version
      id: version
      run: |
        VERSION=$(./mvnw help:evaluate -Dexpression=project.version -q -DforceStdout)
        echo "version=$VERSION" >> "$GITHUB_OUTPUT"

    - name: üì¶ Publish to Maven Central
      env:
        CENTRAL_USERNAME: ${{ secrets.CENTRAL_USERNAME }}
        CENTRAL_PASSWORD: ${{ secrets.CENTRAL_PASSWORD }}
        MAVEN_GPG_PASSPHRASE: ${{ secrets.GPG_PASSPHRASE }}
      run: ./mvnw clean deploy -Prelease -e

    - name: üè∑Ô∏è Create GitHub Release
      id: gh-release
      uses: actions/github-script@v7
      with:
        script: |
          const version = 'v${{ steps.version.outputs.version }}';
          const { data: release } = await github.rest.repos.createRelease({
            owner: context.repo.owner,
            repo: context.repo.repo,
            tag_name: version,
            name: version,
            generate_release_notes: true,
            target_commitish: context.sha,
          });
          core.setOutput('url', release.html_url);
          core.note(`Created release ${release.html_url}`);

    - name: üîÄ Merge to master
      uses: actions/github-script@v7
      with:
        script: |
          const branch = context.ref.replace('refs/heads/', '');
          const { data: commit } = await github.rest.repos.merge({
            owner: context.repo.owner,
            repo: context.repo.repo,
            base: 'master',
            head: branch,
            commit_message: `Merge ${branch}`,
          });
          core.info(`Merged ${branch} to master: ${commit.sha}`);
